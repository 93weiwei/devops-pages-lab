name: Update Activity Log (Enhanced)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"   # æ¯ 12 å°æ™‚æ›´æ–°ä¸€æ¬¡

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch and format activity log
        env:
          GH_USER: ${{ github.repository_owner }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/users/${GH_USER}/events?per_page=30" > events.json

          echo "### ðŸ—ï¸ Categorized GitHub Activity" > activity.md

          echo -e "\n#### ðŸŸ© Push Events" >> activity.md
          jq -r '[.[] | select(.type=="PushEvent")] |
            map("- " + (.created_at[0:19]) + " â€” Push to [" + .repo.name + "](https://github.com/" + .repo.name + ")") |
            .[0:5] | join("\n")' events.json >> activity.md

          echo -e "\n#### ðŸŸ¨ Create Events" >> activity.md
          jq -r '[.[] | select(.type=="CreateEvent")] |
            map("- " + (.created_at[0:19]) + " â€” Created " + .payload.ref_type + " in [" + .repo.name + "](https://github.com/" + .repo.name + ")") |
            .[0:3] | join("\n")' events.json >> activity.md

          echo -e "\n#### ðŸŸ¦ Pull Requests / Issues" >> activity.md
          jq -r '[.[] | select(.type=="PullRequestEvent" or .type=="IssuesEvent")] |
            map("- " + (.created_at[0:19]) + " â€” " + .type + " in [" + .repo.name + "](https://github.com/" + .repo.name + ")") |
            .[0:3] | join("\n")' events.json >> activity.md

          echo "âœ… Activity markdown generated:"
          cat activity.md

      - name: Inject activity into README
        run: |
          START="<!--START_SECTION:activity-->"
          END="<!--END_SECTION:activity-->"
          CONTENT=$(cat activity.md)

          awk -v start="$START" -v end="$END" -v content="$CONTENT" '
            BEGIN { inblock=0 }
            {
              if (index($0, start)) {
                print $0
                print content
                inblock=1
                next
              }
              if (index($0, end)) {
                inblock=0
              }
              if (!inblock) print $0
            }
          ' README.md > README.new

          mv README.new README.md
          echo "README updated with categorized log."

      - name: Commit and push if changed
        run: |
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "âœ¨ chore(activity): categorized update [skip ci]"
            git push
          else
            echo "No changes detected."
          fi
